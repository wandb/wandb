version: 2.1

orbs:
  win: circleci/windows@5.0.0
  slack: circleci/slack@4.12.5
  gcloud: circleci/gcp-cli@3.1.1
  codecov: codecov/codecov@4.0.1

parameters:
  go_version:
    type: string
    default: "1.22.6"
  server_image:
    type: string
    default: "us-central1-docker.pkg.dev/wandb-production/images/local-testcontainer"
    # us-central1-docker.pkg.dev/wandb-client-cicd/images/local-testcontainer
  server_image_tag:
    type: string
    default: "master"

executors:
  macos:
    macos:
      xcode: 15.1.0
    resource_class: macos.m1.medium.gen1

  linux-python:
    parameters:
      python: { type: string }
    docker:
      - image: python:<<parameters.python>>
    resource_class: xlarge

  local-testcontainer:
    parameters:
      python: { type: string }
    docker:
      - image: "python:<<parameters.python>>"
      - image: <<pipeline.parameters.server_image>>:<<pipeline.parameters.server_image_tag>>
        auth:
          username: _json_key
          password: $GCP_SERVICE_ACCOUNT_JSON_DECODED
        environment:
          CI: 1
          WANDB_ENABLE_TEST_CONTAINER: true
    resource_class: xlarge

  local-testcontainer-importers:
    parameters:
      python_version_major: { type: integer }
      python_version_minor: { type: integer }
      dst_server_name:
        type: string
        default: localhost-wandb-2
    docker:
      - image: "python:<<parameters.python_version_major>>.<<parameters.python_version_minor>>"
      # the src server
      - image: <<pipeline.parameters.server_image>>:<<pipeline.parameters.server_image_tag>>
        auth:
          username: _json_key
          password: $GCP_SERVICE_ACCOUNT_JSON_DECODED
        environment:
          CI: 1
          WANDB_ENABLE_TEST_CONTAINER: true
      # the dst server
      - image: <<pipeline.parameters.server_image>>:<<pipeline.parameters.server_image_tag>>
        auth:
          username: _json_key
          password: $GCP_SERVICE_ACCOUNT_JSON_DECODED
        environment:
          CI: 1
          WANDB_ENABLE_TEST_CONTAINER: true
        name: << parameters.dst_server_name >>
    environment:
      WANDB_TEST_SERVER_URL2: http://<< parameters.dst_server_name >>
    resource_class: xlarge

commands:
  save-test-results:
    description: "Save test results"
    steps:
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
      - store_artifacts:
          path: mypy-results
      - store_artifacts:
          path: cover-results

  # We only need a separate command to include this workaround to a bug:
  # https://github.com/codecov/codecov-circleci-orb/issues/185#issuecomment-2072147831
  upload_codecov:
    description: Upload code coverage to codecov.io
    parameters:
      flags: { type: string }
    steps:
      - run: mkdir -p ~/.gnupg
      - codecov/upload: { flags: <<parameters.flags>> }

  run-nox-tests:
    description:
      Helper command for the nox-tests-* jobs. Runs a nox session and uploads
      tests artifacts.
    parameters:
      python: { type: string }
      session: { type: string }
      yea_shard: { type: string }
      codecov_flags: { type: string }
    steps:
      - run:
          name: Install Python dependencies
          command: python -m pip install -U nox pip uv
          no_output_timeout: 5m

      - run:
          name: "Run nox session: <<parameters.session>>"
          no_output_timeout: 10m
          command: >
            nox -s "<<parameters.session>>" --python <<parameters.python>>
          environment:
            YEA_SHARD: <<parameters.yea_shard>>

      - upload_codecov: { flags: <<parameters.codecov_flags>> }
      - save-test-results

  install_go:
    description: "Install Go with the specified version and system"
    parameters:
      version:
        description: "Go version"
        type: string
        default: << pipeline.parameters.go_version >>
    steps:
      - run:
          name: Install Go
          command: |
            file_name=go<<parameters.version>>
            case $(uname -m) in
              x86_64)
                arch="amd64"
                ;;
              arm64)
                arch="arm64"
                ;;
              *)
                echo "Unsupported architecture: $(uname -m)"
                exit 1
                ;;
            esac

            case $(uname | tr '[:upper:]' '[:lower:]') in
              msys*)
                file_name=$file_name.windows-$arch.zip
                suffix="zip"
                ;;
              darwin*)
                file_name=$file_name.darwin-$arch.tar.gz
                suffix="tar.gz"
                ;;
              linux*)
                file_name=$file_name.linux-$arch.tar.gz
                suffix="tar.gz"
                ;;
              *)
                echo "Unsupported OS: $(uname)"
                exit 1
                ;;
            esac

            curl -L -o $file_name https://go.dev/dl/$file_name
            case $suffix in
              zip)
                unzip -q $file_name -d $HOME
                ;;
              tar.gz)
                tar -C $HOME -xzf $file_name
                ;;
            esac

            rm $file_name

            echo 'export PATH="$HOME/go/bin:$PATH"' >> "$BASH_ENV"

            $HOME/go/bin/go version
            $HOME/go/bin/go env -w GOCACHE=$HOME/.cache/go-build
          no_output_timeout: 1m

  install_rust:
    description: "Install Rust with the specified version"
    parameters:
      version:
        description: "Rust version"
        type: string
        default: "stable"
    steps:
      - run:
          name: Install Rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain <<parameters.version>>
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$BASH_ENV"
            $HOME/.cargo/bin/rustup --version
            $HOME/.cargo/bin/cargo --version
          no_output_timeout: 1m

  setup_gcloud:
    parameters:
      container_registry:
        description: "Container registry to authenticate with"
        type: string
        default: "us-central1-docker.pkg.dev"
    steps:
      - run:
          name: "Setup gcloud and kubectl"
          # gcloud --quiet components update
          command: |
            echo $GCLOUD_SERVICE_KEY > ${HOME}/gcloud-service-key.json
            gcloud --quiet components install gke-gcloud-auth-plugin
            gcloud --quiet components install kubectl
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud --quiet config set project $GOOGLE_PROJECT_ID
            gcloud --quiet config set compute/zone $GOOGLE_COMPUTE_ZONE
            gcloud auth configure-docker --quiet << parameters.container_registry >>

  restore_cache_tox:
    steps:
      - run:
          name: Store current date
          command: date "+%F" > tox-cache-date.txt
      - restore_cache:
          name: Restore .tox cache
          keys:
            # Note that virtualenvs are not portable! We include the job name
            # in the key in the hopes that it encapsulates the Python version.
            # We include the architecture (OS + processor) as well to be safe.
            - &tox-cache v2-tox-{{ .Environment.CIRCLE_JOB }}-{{ arch }}-{{
              checksum "tox-cache-date.txt" }}-{{
              checksum "requirements_dev.txt" }}-{{
              checksum "requirements_test.txt" }}-{{
              checksum "tox.ini" }}
            - v2-tox-{{ .Environment.CIRCLE_JOB }}-{{ arch }}-{{
              checksum "tox-cache-date.txt" }}
  save_cache_tox:
    steps:
      - save_cache:
          name: Upload .tox cache
          key: *tox-cache
          paths: [.tox]

jobs:
  nox-tests-linux:
    parameters:
      executor_name:
        description:
          Set to "local-testcontainer" to run using the local-testcontainer
          executor. Defaults to "linux-python".
        type: string
        default: linux-python
      parallelism: { type: integer }
      codecov_flags: { type: string }
      python: { type: string }
      session: { type: string }
      yea_shard: # if running tests with yea, like functional_tests
        default: ""
        type: string

    parallelism: <<parameters.parallelism>>
    executor:
      name: <<parameters.executor_name>>
      python: <<parameters.python>>

    steps:
      - checkout
      - run:
          name: Install system deps
          command: apt-get update && apt-get install -y libsndfile1 ffmpeg
      - install_go
      - install_rust
      - run-nox-tests:
          codecov_flags: <<parameters.codecov_flags>>
          python: <<parameters.python>>
          session: <<parameters.session>>
          yea_shard: <<parameters.yea_shard>>

  nox-tests-macos:
    parameters:
      parallelism: { type: integer }
      codecov_flags: { type: string }
      python: { type: string }
      session: { type: string }
      yea_shard: # if running tests with yea, like functional_tests
        default: ""
        type: string

    parallelism: <<parameters.parallelism>>
    executor: macos

    steps:
      - checkout
      - run:
          name: Install system deps
          command: brew install ffmpeg python@<<parameters.python>>
      - install_go
      - run-nox-tests:
          codecov_flags: <<parameters.codecov_flags>>
          python: <<parameters.python>>
          session: <<parameters.session>>
          yea_shard: <<parameters.yea_shard>>

  nox-tests-win:
    parameters:
      parallelism: { type: integer }
      codecov_flags: { type: string }
      python: { type: string }
      session: { type: string }
      yea_shard: # if running tests with yea, like functional_tests
        default: ""
        type: string

    parallelism: <<parameters.parallelism>>
    executor:
      name: win/server-2019
      size: large
      shell: bash.exe

    steps:
      - checkout

      # https://docs.python.org/3/using/windows.html#the-nuget-org-packages
      - run:
          name: Install Python
          command: >
            nuget.exe install python \
              -Version <<parameters.python>> \
              -ExcludeVersion \
              -OutputDirectory "/c/nox-tests-python" &&
            setx PATH '/c/nox-tests-python/python/tools;%PATH%'

      - run:
          name: "Install system deps: ffmpeg"
          command: choco install -y ffmpeg
      - run:
          # We install mingw so that gcc is available, which is needed for cgo.
          name: "Install system deps: mingw"
          command: choco install -y mingw --version 12.2 --allow-downgrade

      - install_go
      - run-nox-tests:
          codecov_flags: <<parameters.codecov_flags>>
          python: <<parameters.python>>
          session: <<parameters.session>>
          yea_shard: <<parameters.yea_shard>>

  code-check:
    docker:
      - image: "python:3.10"
    steps:
      - checkout
      - install_go
      - install_rust
      - run:
          name: Install Python dependencies
          command: python -m pip install -U tox nox pip uv
          no_output_timeout: 5m
      - run:
          name: Ensure proto files were generated
          command: nox -vt proto-check
      - run:
          name: Automatically generate code and check for changes
          command: nox -vs codegen -- --check
      - run:
          name: Run mypy and report results
          command: nox -vs mypy-report
      - save-test-results

  tox-base:
    parameters:
      python_version_major:
        type: integer
        default: 3
      python_version_minor:
        type: integer
        default: 9
      toxenv:
        type: string
      coverage_dir:
        type: string
        default: ""
      codecov_flags:
        type: string
        default: ""
      shard:
        type: string
        default: "default"
      notify_on_failure:
        type: boolean
        default: false
      notify_on_failure_channel:
        type: string
        default: "$SLACK_SDK_NIGHTLY_CI_CHANNEL"
      parallelism:
        type: integer
        default: 1
      execute:
        type: boolean
        default: true
      tox_args:
        type: string
        default: ""
    docker:
      - image: "python:<<parameters.python_version_major>>.<<parameters.python_version_minor>>"
    environment:
      SHARD: << parameters.shard >>
      COVERAGE_DIR: << parameters.coverage_dir >>
    parallelism: << parameters.parallelism >>
    resource_class: xlarge
    working_directory: /mnt/ramdisk
    steps:
      - checkout
      - when:
          condition: << parameters.execute >>
          steps:
            - run:
                name: Install system deps
                command: |
                  apt-get update && apt-get install -y libsndfile1 ffmpeg
            - install_go
            - install_rust
            - run:
                name: Install Python dependencies
                command: python -m pip install -U tox nox pip uv
                no_output_timeout: 5m
            - restore_cache_tox
            - run:
                name: Run tests
                no_output_timeout: 15m
                command: |
                  CI_PYTEST_SPLIT_ARGS="--splits $CIRCLE_NODE_TOTAL --group $(( $CIRCLE_NODE_INDEX + 1 ))" \
                  tox run -v -e << parameters.toxenv >> -- << parameters.tox_args >>
            - save_cache_tox
            - when:
                condition:
                  not:
                    equal: ["", << parameters.codecov_flags >>]
                steps:
                  - upload_codecov: { flags: <<parameters.codecov_flags>> }
            - save-test-results
            # conditionally post a notification to slack if the job failed
            - when:
                condition: << parameters.notify_on_failure >>
                steps:
                  - slack/notify:
                      event: fail
                      template: basic_fail_1
                      mentions: "@channel"
                      # taken from slack-secrets context
                      channel: << parameters.notify_on_failure_channel >>

  importers:
    parameters:
      executor: { type: executor }
      python_version_major: { type: integer }
      python_version_minor: { type: integer }
      tests:
        type: enum
        enum: [wandb, mlflow]
      xdist:
        type: integer
        default: 3
    executor: << parameters.executor >>
    steps:
      - checkout
      - run:
          name: Install system deps
          command: |
            apt-get update
            apt-get install -y libsndfile1 ffmpeg
      - install_go
      - install_rust
      - run:
          name: Install Python dependencies
          command: python -m pip install -U tox nox pip uv
          no_output_timeout: 5m
      - restore_cache_tox
      - run:
          name: Run tests
          no_output_timeout: 10m
          command: |
            CI_PYTEST_PARALLEL=<< parameters.xdist >> \
            tox run -v \
              -e importer-<<parameters.tests>>-py<<parameters.python_version_major>><<parameters.python_version_minor>>  \
              -- $(if [ "<<parameters.tests>>" = "wandb" ]; then echo "--wandb-second-server=true"; fi) \
              tests/pytest_tests/system_tests/test_importers/test_<<parameters.tests>>/
      - save_cache_tox
      - upload_codecov: { flags: system }
      - save-test-results

  unit-tests-go:
    docker:
      - image: cimg/go:<<pipeline.parameters.go_version>>
    steps:
      - checkout
      - run:
          name: Run wandb core's Go tests and collect coverage
          command: |
            cd core
            go test -race -coverprofile=coverage.txt -covermode=atomic ./...
      - upload_codecov: { flags: unit }

  # Download the local-testcontainer image corresponding to the latest server release
  # and store it in wandb-client-cicd/images/local-testcontainer.
  # No-op if already stored.
  store-local-testcontainer:
    parameters:
      python_version_major:
        type: integer
        default: 3
      python_version_minor:
        type: integer
        default: 11
    docker:
      - image: "python:<<parameters.python_version_major>>.<<parameters.python_version_minor>>"
    resource_class: small
    working_directory: /mnt/ramdisk
    steps:
      - checkout
      - run:
          name: Install system deps
          command: |
            apt-get update
      - install_go
      - gcloud/install
      - setup_gcloud
      - run:
          name:
          command: |
            go install github.com/google/go-containerregistry/cmd/gcrane@latest
            python -m pip install -U pip nox requests uv
            nox -s local-testcontainer-registry
          no_output_timeout: 5m

  # NOTE: This is deprecated and being replaced by nox-tests-win.
  win:
    parameters:
      python_version_major:
        type: integer
        default: 3
      python_version_minor:
        type: integer
        default: 9
      toxenv:
        type: string
      coverage_dir:
        type: string
        default: ""
      codecov_flags:
        type: string
        default: ""
      parallelism:
        type: integer
        default: 4
      xdist:
        type: integer
        default: 3
      machine_executor:
        type: string
        default: "default" # "default" or "server-2019-cuda"
      executor_size:
        type: string
        default: "large" # could only be "medium" for "server-2019-cuda"
      execute:
        type: boolean
        default: true
      tox_args:
        type: string
        default: ""
    executor:
      name: win/<< parameters.machine_executor >>
      size: << parameters.executor_size >>
      shell: bash.exe
    parallelism: << parameters.parallelism >>
    environment:
      COVERAGE_DIR: << parameters.coverage_dir >>
    steps:
      - checkout
      - when:
          condition: << parameters.execute >>
          steps:
            - run:
                # We install mingw so that gcc is available, which is needed for cgo.
                name: "Install system deps: mingw"
                command: choco install -y mingw --version 12.2 --allow-downgrade
            - run:
                name: Install python dependencies
                command: |
                  python -m pip install -U tox nox pip uv
            - when:
                condition:
                  equal: ["server-2019-cuda", << parameters.machine_executor >>]
                steps:
                  - run:
                      name: Update tox.ini on a GPU machine to install the proper pytorch version
                      command: |
                        CUDA_VERSION=`ls "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA"`
                        CUDA_VERSION_NO_DOT=`echo "${CUDA_VERSION//./}"`
                        v=${CUDA_VERSION_NO_DOT:1}
                        sed -i -e "s/whl\/cpu/whl\/cu$v/g" tox.ini
            - install_go
            - run:
                name: Run tests
                command: |
                  echo $GCLOUD_SERVICE_KEY > key.json
                  gcloud auth activate-service-account --key-file=key.json
                  yes | gcloud auth configure-docker
                  DATE=$(date -u +%Y%m%d) CI_PYTEST_PARALLEL=<< parameters.xdist >> CI_PYTEST_SPLIT_ARGS="--splits $CIRCLE_NODE_TOTAL --group $(( $CIRCLE_NODE_INDEX + 1 ))" tox run -v -e << parameters.toxenv >> -- << parameters.tox_args >>
                no_output_timeout: 10m
            - when:
                condition:
                  not:
                    equal: ["", << parameters.codecov_flags >>]
                steps:
                  - upload_codecov: { flags: <<parameters.codecov_flags>> }
            - save-test-results

  launch:
    parameters:
      toxenv:
        type: string
      tox_args:
        type: string
      python_version_major:
        type: integer
        default: 3
      python_version_minor:
        type: integer
        default: 9
      codecov_flags:
        type: string
        default: ""
    machine:
      image: ubuntu-2004:2024.01.1
      docker_layer_caching: true
    resource_class: large
    steps:
      - attach_workspace:
          at: .
      - checkout
      - install_rust
      - run:
          name: Install python 3.9
          command: |
            sudo apt-get update
            sudo apt update
            sudo apt install -y python3.9
      - run:
          name: Install python dependencies, build r2d
          command: |
            pip3 install tox nox uv chardet iso8601
      - run:
          name: pull base docker images
          command: |
            docker pull python:3.9-buster
      - run:
          name: Run tests
          command: |
            python3 -m tox run -v -e << parameters.toxenv >> -- << parameters.tox_args >>
          no_output_timeout: 10m
      - when:
          condition:
            not:
              equal: ["", << parameters.codecov_flags >>]
          steps:
            - upload_codecov: { flags: <<parameters.codecov_flags>> }
      - save-test-results

  slack_notify:
    parameters:
      message:
        type: string
        default: ":runner:"
      execute:
        type: boolean
        default: true
    docker:
      - image: "cimg/base:stable"
    steps:
      - when:
          condition: << parameters.execute >>
          steps:
            - slack/notify:
                custom: |
                  {
                    "blocks": [
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "plain_text",
                            "text": "<< parameters.message >>",
                            "emoji": true
                          }
                        ]
                      }
                    ]
                  }
                event: always
                channel: $SLACK_SDK_NIGHTLY_CI_CHANNEL
      # this is to make sure `steps` is not empty
      - run:
          name: Print message to stdout
          command: echo << parameters.message >>

workflows:
  main:
    jobs:
      #
      # Linting
      #
      - code-check

      #
      # Store latest local-testcontainer
      #
      - store-local-testcontainer:
          filters:
            branches:
              only:
                - main

      #
      # Unit tests with pytest on Linux, using the old mock server
      #
      - tox-base:
          matrix:
            parameters:
              python_version_major: [3]
              python_version_minor: [10]
          name: "unit-legacy-linux-py<<matrix.python_version_major>><<matrix.python_version_minor>>"
          toxenv: "py<<matrix.python_version_major>><<matrix.python_version_minor>>"
          tox_args: "tests/pytest_tests/unit_tests_old --ignore=tests/pytest_tests/unit_tests_old/test_launch"
          codecov_flags: unit

      - win:
          filters:
            branches:
              only:
                # - main
                - /^release-.*/
                - /^.*-ci-win$/
          matrix:
            parameters:
              python_version_major: [3]
              python_version_minor: [9]
          name: "unit-legacy-win-py<<matrix.python_version_major>><<matrix.python_version_minor>>"
          toxenv: "py<<matrix.python_version_major>><<matrix.python_version_minor>>"
          codecov_flags: unit
          tox_args: "tests/pytest_tests/unit_tests_old --ignore=tests/pytest_tests/unit_tests_old/test_launch"

      #
      # wandb launch tests
      #
      - launch:
          matrix:
            parameters:
              python_version_major: [3]
              python_version_minor: [9]
          name: "unit-legacy-launch-linux-py<<matrix.python_version_major>><<matrix.python_version_minor>>"
          toxenv: "py<<matrix.python_version_major>><<matrix.python_version_minor>>"
          codecov_flags: unit
          tox_args: "tests/pytest_tests/unit_tests_old/test_launch/"

      #
      # Unit tests with Go on Linux
      #
      - unit-tests-go

      #
      # Unit tests with pytest on Linux
      #
      - nox-tests-linux:
          name: unit-tests-linux-<<matrix.python>>
          session: unit_tests
          codecov_flags: unit
          parallelism: 4

          matrix:
            parameters:
              python: ["3.8", "3.12"]

      #
      # Unit tests with pytest on macOS
      #
      - nox-tests-macos:
          name: unit-tests-macos-<<matrix.python>>
          session: unit_tests
          codecov_flags: unit
          parallelism: 4

          matrix:
            parameters:
              python: ["3.9", "3.12"]

      #
      # Unit tests with pytest on Windows
      #
      - nox-tests-win:
          name: unit-tests-win-<<matrix.python>>
          session: unit_tests
          codecov_flags: unit
          parallelism: 4

          filters:
            branches:
              only:
                - main
                - /^release-.*/
                - /^.*-ci-win$/

          matrix:
            parameters:
              python: ["3.9", "3.12"]

      #
      # System tests on Linux
      #
      - nox-tests-linux:
          name: system-tests-linux-<<matrix.python>>
          session: system_tests
          codecov_flags: system
          parallelism: 8
          executor_name: local-testcontainer

          filters:
            branches:
              # Forked pull requests have CIRCLE_BRANCH set to pull/XXX
              ignore: /pull\/[0-9]+/

          matrix:
            parameters:
              python: ["3.8", "3.12"]

      - nox-tests-linux:
          name: notebook-tests-linux-<<matrix.python>>
          session: notebook_tests
          codecov_flags: system
          parallelism: 1
          executor_name: local-testcontainer

          matrix:
            parameters:
              python: ["3.8", "3.12"]

      #
      # W&B Importer tests on Linux, using 2 real wandb servers
      #
      - importers:
          name: "\
            system-tests-linux-importers-\
            <<matrix.tests>>-\
            <<matrix.python_version_major>>-\
            <<matrix.python_version_minor>>"

          matrix:
            parameters:
              python_version_major: [3]
              python_version_minor: [9]
              tests: ["wandb", "mlflow"]

          executor:
            name: local-testcontainer-importers
            python_version_major: << matrix.python_version_major >>
            python_version_minor: << matrix.python_version_minor >>

      #
      # Functional tests with yea on Linux
      #
      - nox-tests-linux:
          name: "\
            func-tests-linux-\
            <<matrix.yea_shard>>-\
            <<matrix.python>>"
          session: functional_tests
          codecov_flags: func
          parallelism: 4

          matrix:
            parameters:
              yea_shard: [default, artifacts, launch, mitm, docs]
              python: ["3.9"]

      #
      # Functional tests with yea on Windows
      #
      - nox-tests-win:
          name: func-tests-win-default-<<matrix.python>>
          session: functional_tests
          yea_shard: default
          codecov_flags: func
          parallelism: 4

          filters:
            branches:
              only:
                - main
                - /^release-.*/
                - /^.*-ci-win$/

          matrix:
            parameters:
              python: ["3.9"]
