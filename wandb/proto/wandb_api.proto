syntax = "proto3";

package wandb_internal;

import "wandb/proto/wandb_settings.proto";

option go_package = "core/pkg/service_go_proto";

// ServerApiInitRequest instructs the backend process
// to initialize resources to handle ApiRequests.
//
// This should be sent once prior to sending any ApiRequests.
message ServerApiInitRequest {
  Settings settings = 1;
}

// ApiRequest is a request to the backend process
// to perform an action related to an API call.
message ApiRequest {
  oneof request {
    ReadRunHistoryRequest read_run_history_request = 1;
  }
}

message ServerApiInitResponse {
  string error_message = 1;
}

// ApiResponse is a response from the backend process for an ApiRequest.
message ApiResponse {
  oneof response {
    ReadRunHistoryResponse read_run_history_response = 1;
    DownloadRunHistoryResponse download_run_history_response = 3;

    ApiErrorResponse api_error_response = 2;
  }
}

message ApiErrorResponse {
  string message = 1;
  optional ErrorType error_type = 2;
}

enum ErrorType {
  INCOMPLETE_RUN_HISTORY_ERROR = 0;
}

// Start of Scan run history

message ReadRunHistoryRequest {
  oneof request {
    ScanRunHistoryInit scan_run_history_init = 1;
    ScanRunHistory scan_run_history = 2;
    ScanRunHistoryCleanup scan_run_history_cleanup = 3;
    DownloadRunHistory download_run_history = 4;
  }
}

message ReadRunHistoryResponse {
  oneof response {
    ScanRunHistoryInitResponse scan_run_history_init = 1;
    RunHistoryResponse run_history = 2;
    ScanRunHistoryCleanupResponse scan_run_history_cleanup = 3;
    DownloadRunHistoryResponse download_run_history = 4;
  }
}

// ScanRunHistoryInit is a request to initialize
// a scan over a run's history.
//
// Because scan history request will be made over a series of requests,
// We want to keep initialize and keep track of the resources
// associated with the scan request.
message ScanRunHistoryInit {
  string entity = 1;
  string project = 2;
  string run_id = 3;
  repeated string keys = 4;
  bool use_cache = 5;
}

message ScanRunHistoryInitResponse {
  int32 request_id = 1;
}

// ScanRunHistory is a request to scan
// over a portion of a run's history.
message ScanRunHistory {
  int64 min_step = 1;
  int64 max_step = 2;
  int32 request_id = 3;
}

message RunHistoryResponse {
  repeated HistoryRow history_rows = 1;
}

message HistoryRow {
  repeated ParquetHistoryItem history_items = 1;
}

message ParquetHistoryItem {
  string key = 1;
  string value_json = 16;
}

// ScanRunHistoryCleanup is a request to cleanup
// any resources associated with a scan request.
message ScanRunHistoryCleanup {
  int32 request_id = 1;
}

message ScanRunHistoryCleanupResponse {}

// End of Scan run history

// Download run history

// A request to download a run's history exports.
message DownloadRunHistory {
  // The entity who owns the run.
  string entity = 1;
  // The project that the run belongs to.
  string project = 2;
  // The ID of the run.
  string run_id = 3;

  // The directory to store the downloaded history files within.
  string download_dir = 4;

  // Whether to require the complete history to be downloaded.
  // If the run contains data that has not been exported to parquet files yet,
  // the run history will be considered incomplete.
  bool require_complete_history = 5;
}

// A response to a DownloadRunHistory request.
message DownloadRunHistoryResponse {
  // The list of file names that were downloaded.
  // Each value is the full path to the downloaded file.
  repeated string file_names = 1;

  // Whether the run contains data that has not been exported to parquet files yet.
  bool contains_live_data = 2;
}

// IncompleteRunHistoryError is an error that is returned when the run history
// has live data that has not been exported to parquet files yet.
message IncompleteRunHistoryError {}